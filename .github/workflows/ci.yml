# Workflow Name
name: 'Full_Stack_Demo'

# Auslösung des Workflows bei Schritten:
on:
    push:
        branches: ['master']
    pull_request:
        branches: ['master']
    workflow_dispatch:

# Verhindere parallele Builds für den selben Branch
concurrency:
    group: ci-${{github.ref}}
    cancel-in-progress: true

permissions:
    contents: read

env:
    NODE_LTS: '20'

jobs:
    # ========================================================
    # BUILD + TEST
    # ========================================================
    build_test:
        name: Build & Test
        # Ubuntu-VM als Runner
        runs-on: ubuntu-latest

        strategy:
            # Stoppe nicht alle Matrix-Jobs bei erstem Fehler
            fail-fast: false

            matrix:
                node-version: [20.x, 22.x]

        steps:
            # Lade den Repository Code auf den Runner
            - name: Checkout Repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 

            # Installiere der jeweiligen Node-Version aus der Matrix
            - name: Install Node.js ${{matrix.node-version}}
              uses: actions/setup-node@efcb663fc60e97218a2b2d6d827f7830f164739e
              with:
                  node-version: ${{matrix.node-version}}
                  # Aktiviere Cache für schnellere Build
                  cache: 'npm'
                  cache-dependency-path: |
                      frontend/package-lock.json
                      backend/package-lock.json

            - name: Frontend:intall/lint/test/build
              working-directory: frontend
              run: |
                  npm ci
                  npm run lint --if-present
                  npm test --if-present
                  npm run build --if-present

            - name: Backend:intall/lint/test/build
              working-directory: backend
              run: |
                  npm ci
                  npm run lint --if-present
                  npm test --if-present
                  npm run build --if-present

            - name: Upload dist (frontend)
              uses: actions/upload-artifact@604373da6381bf24206979c74d06a550515601b9
              with:
                  name: dist-frontend-${{matrix.node-version}}
                  path: frontend/dist
                  if-no-files-found: ignore

            - name: Upload dist (backend)
              uses: actions/upload-artifact@604373da6381bf24206979c74d06a550515601b9
              with:
                  name: dist-backend-${{matrix.node-version}}
                  path: backend/dist
                  if-no-files-found: ignore
    
    # ========================================================
    # DEPS Review für Pull Request
    # ========================================================
    dependency_review:
      name: Deps Review
      runs-on: ubuntu-latest
      permissions: 
        contents: read
        pull-requests: read
      if: github.event_name == 'pull_request'
      steps: 
        - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        - uses: actions/dependency-review-action@4fa8b92807a6c64f466af1fb5840374d9e88f668
          with: 
            fail-on-severity: high


    # ========================================================
    # SECRET_KEYS_LEAK 
    # ========================================================
    gitleaks: 
      name: Secret Scan (Git_Leaks)
      runs-on: ubuntu-latest
      permissions: 
        contents: read
      steps: 
       - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
         with: 
          fetch-depth: 0
       - name: Run GitLeaks
         uses: gitleaks/gitleaks-action@44c470ffc35caa8b1eb3e8012ca53c2f9bea4eb5
         env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}} 

    # ========================================================
    # SINGLE SMON + SCA (OSV):
    # ========================================================
    sbom_sca:
        name: SBOM(CycloneDX) + SCA (OSV)
        runs-on: ubuntu-latest
        # Braucht fertiges build_test zum Starten
        needs: [build_test]
        permissions:
            contents: read

        steps:
            - name: Checkout Repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

            - name: Setup Node (LTS)
              uses: actions/setup-node@efcb663fc60e97218a2b2d6d827f7830f164739e
              with:
                  node-version: ${{env.NODE_LTS}}
                  cache: npm
                  cache-dependency-path: |
                      frontend/package-lock.json
                      backend/package-lock.json

            - name: Install OSV-Scanner
              run: |
                  curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
                  chmod +x osv-scanner
                  sudo mv osv-scanner /usr/local/bin/osv-scanner

            - name: Install CycloneDX CLI
              run: |
                  curl -L https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64 -o cyclonedx
                  chmod +x cyclonedx
                  sudo mv cyclonedx /usr/local/bin/cyclonedx

            - name: Decide SBOM Mode
              id: mode
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    echo "omit_dev=false" >> $GITHUB_OUTPUT
                  else
                    echo "omit_dev=true" >> $GITHUB_OUTPUT
                  fi

            - name: Generate SBOM (frontend)
              working-directory: frontend
              run: |
                  rm -rf node_modules
                  if [ "${{ steps.mode.outputs.omit_dev }}" = "true" ]; then
                    npm ci --omit=dev
                    npx --yes @cyclonedx/cyclonedx-npm --omit dev --output-file ../sbom-frontend.cdx.json --output-format json
                  else
                    npm ci
                    npx --yes @cyclonedx/cyclonedx-npm --output-file ../sbom-frontend.cdx.json --output-format json
                  fi

            - name: Generate SBOM (backend)
              working-directory: backend
              run: |
                  rm -rf node_modules
                  if [ "${{ steps.mode.outputs.omit_dev }}" = "true" ]; then
                    npm ci --omit=dev
                    npx --yes @cyclonedx/cyclonedx-npm --omit dev --output-file ../sbom-backend.cdx.json --output-format json
                  else
                    npm ci
                    npx --yes @cyclonedx/cyclonedx-npm --output-file ../sbom-backend.cdx.json --output-format json
                  fi

            - name: Merge
              run: |
                  cyclonedx merge \
                  --input-files sbom-frontend.cdx.json sbom-backend.cdx.json \
                  --output-file sbom-fullstack.cdx.json

            - name: OSV Scan
              run: |
                  osv-scanner scan --sbom=sbom-fullstack.cdx.json --format=json > osv.json || true
                  jq '
                  .results[].packages[].vulnerabilities[]
                  | select(.severity[] | contains("HIGH") or contains("CRITICAL")
                  ' osv.json | grep . && exit 1 || exit 0

            - name: Upload Single SBOM Artifact
              uses: actions/upload-artifact@604373da6381bf24206979c74d06a550515601b9
              with:
                  name: sbom-fullstack-cyclonedx
                  path: sbom-fullstack.cdx.json
                  if-no-files-found: ignore

    # ========================================================
    # SAST CodeQL:
    # ========================================================
    codeql:
        name: SAST (CodeQL)
        runs-on: ubuntu-latest

        # Starte erst wenn frontend/backend(build_test) und SBOM_SCA fertig sind
        needs: [build_test, sbom_sca]

        permissions:
            actions: read
            contents: read
            security-events: write

        strategy:
            fail-fast: false
            matrix:
                project: ['frontend', 'backend']

        steps:
            - name: Checkout repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

            - name: Setup Node (LTS)
              uses: actions/setup-node@efcb663fc60e97218a2b2d6d827f7830f164739e
              with:
                  node-version: ${{env.NODE_LTS}}
                  cache: npm
                  cache-dependency-path: ${{matrix.project}}/package-lock.json

            # Intalliere Dependencies im jeweiligen Unterprojekt
            - name: Install Dependencies
              working-directory: ${{matrix.project}}
              run: npm ci

            # CodeQL auf den jeweiligen Ordner fokussieren
            - name: Initialize CodeQL
              uses: github/codeql-action/init@4edc7d2e8233bed8da52eef87a714924d761469d
              with:
                  languages: javascript
                  source-root: ${{matrix.project}}

            - name: Autobuild
              uses: github/codeql-action/autobuild@4edc7d2e8233bed8da52eef87a714924d761469d

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@4edc7d2e8233bed8da52eef87a714924d761469d
