# Workflow Name
name: 'Full_Stack_Demo'

# Auslösung des Workflows bei Schritten:
on:
    push:
        branches: ['master']
    pull_request:
        branches: ['master']

# Verhindere parallele Builds für den selben Branch
concurrency:
    group: ci-${{github.ref}}
    cancel-in-progress: true

jobs:
    # ========================================================
    # FRONTEND:
    # ========================================================
    frontend:
        # Ubuntu-VM als Runner
        runs-on: ubuntu-latest

        strategy:
            # Stoppe nicht alle Matrix-Jobs bei erstem Fehler
            fail-fast: false

            matrix:
                node-version: [20.x, 22.x]

        # Default Arbeitsverzeichnis für alle folgende run-Befehle
        defaults:
            run:
                working-directory: frontend

        steps:
            # Lade den Repository Code auf den Runner
            - name: Checkout Repository
              uses: actions/checkout@v4

            # Installiere der jeweiligen Node-Version aus der Matrix
            - name: Install Node.js ${{matrix.node-version}}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{matrix.node-version}}
                  # Aktiviere Cache für schnellere Build
                  cache: 'npm'
                  cache-dependency-path: frontend/package-lock.json

            # Installiere der Dependencies
            - name: Install Dependencies
              run: npm ci

            # PLATZHALTER: Führe Linter aus (falls vorhanden)
            - name: Run Linter
              run: npm run lint --if-present

            # PLATZHALTER: Führe Tests aus (falls vorhanden)
            - name: Test
              run: npm test --if-present

            # Frontend Aufbau
            - name: Build Frontend
              run: npm run build --if-present

            # Speichere Build als Artifact
            - name: Upload Frontend Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-build-${{matrix.node-version}}
                  path: frontend/dist
                  if-no-files-found: ignore

    # ========================================================
    # BACKEND:
    # ========================================================
    backend:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                node-version: [20.x, 22.x]

        defaults:
            run:
                working-directory: backend

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            # Node-Version Konfigurieren
            - name: Install Node.js ${{matrix.node-version}}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{matrix.node-version}}
                  cache: npm
                  cache-dependency-path: backend/package-lock.json

            # Installiere der Dependencies
            - name: Install Dependencies
              run: npm ci

            # PLATZHALTER: Führe Linter aus (falls vorhanden)
            - name: Run Linter
              run: npm run lint --if-present

            # PLATZHALTER: Führe Tests aus (falls vorhanden)
            - name: Test
              run: npm test --if-present

            # BACKEND Aufbau
            - name: Build Backend
              run: npm run build --if-present

            # Speichere Build als Artifact
            - name: Upload Backend Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: backend-build-${{matrix.node-version}}
                  path: backend/dist
                  if-no-files-found: ignore
    # ========================================================
    # SCA (OSV):
    # ========================================================
    sca:
        name: SCA (OSV)
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
                  cache-dependency-path: |
                      frontend/package-lock.json
                      backend/package-lock.json

            - name: Install OSV-Scanner
              run: |
                  curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
                  chmod +x osv-scanner
                  sudo mv osv-scanner /usr/local/bin/osv-scanner

            - name: Scan Frontend
              working-directory: frontend
              run: |
                  rm -rf node_modules package-lock.json
                  npm install --omit=dev --package-lock-only
                  osv-scanner scan --lockfile=package-lock.json

            - name: Scan Backend
              working-directory: backend
              run: |
                  rm -rf node_modules package-lock.json
                  npm install --omit=dev --package-lock-only
                  osv-scanner scan --lockfile=package-lock.json

    # ========================================================
    # SAST CodeQL:
    # ========================================================
    codeql:
        name: SAST (CodeQL)
        runs-on: ubuntu-latest

        # Starte erst wenn frontend und backend fertig sind
        needs: [frontend, backend]

        permissions:
            actions: read
            contents: read
            security-events: write

        strategy:
            fail-fast: false
            matrix:
                project: ['frontend', 'backend']

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
                  cache-dependency-path: ${{matrix.project}}/package-lock.json

            # Intalliere Dependencies im jeweiligen Unterprojekt
            - name: Install Dependencies
              working-directory: ${{matrix.project}}
              run: npm ci

            # CodeQL auf den jeweiligen Ordner fokussieren
            - name: Initialize CodeQL
              uses: github/codeql-action/init@v4
              with:
                  languages: javascript-typescript
                  source-root: ${{matrix.project}}

            - name: Autobuild
              uses: github/codeql-action/autobuild@v4

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v4
